name: ğŸš€ Deploy Lessions API

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸ“¥ Checkout do cÃ³digo"
        uses: actions/checkout@v4
        with:
          ref: main
          
      - name: "ğŸ”‘ Configurar SSH"
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LESSIONS_SSH_KEY }}" > ~/.ssh/deployer_key
          chmod 600 ~/.ssh/deployer_key
          ssh-keyscan -p 3005 170.80.234.117 >> ~/.ssh/known_hosts
          
      - name: "ğŸ”“ Preparar permissÃµes no servidor"
        run: |
          echo "ğŸ”“ Preparando permissÃµes..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deployer_key -p 3005 deployer@170.80.234.117 "
            # Dar controle total ao deployer temporariamente
            sudo chown -R deployer:deployer /var/www/apis/lessions/
            sudo chmod -R 775 /var/www/apis/lessions/
            echo 'âœ… PermissÃµes liberadas para deployer'
          "
      

      - name: "ğŸ” DEBUG - Lessions API"
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deployer_key -p 3005 deployer@170.80.234.117 "
            echo '=== DEBUG LESSIONS ==='
            echo '1. Dono da pasta:'
            ls -ld /var/www/apis/lessions
            echo '2. Teste de escrita:'
            touch /var/www/apis/lessions/teste_lessions.txt && echo 'âœ… LESSIONS: Pode escrever' || echo 'âŒ LESSIONS: NÃƒO pode escrever'
            echo '3. PermissÃµes:'
            ls -la /var/www/apis/lessions/ | head -3
            echo '=== FIM DEBUG LESSIONS ==='
          "



      - name: "ğŸ“¤ Sincronizar cÃ³digo"
        run: |
          echo "ğŸ”„ Sincronizando cÃ³digo..."
          rsync -avz --delete \
            --no-perms \
            --no-owner \
            --no-group \
            --no-times \
            -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/deployer_key -p 3005" \
            --exclude 'venv/' \
            --exclude '__pycache__/' \
            --exclude '*.pyc' \
            --exclude '.env' \
            --exclude '.git/' \
            --exclude '*.swp' \
            ./ deployer@170.80.234.117:/var/www/apis/lessions/
          echo "âœ… CÃ³digo sincronizado com sucesso!"
          
      - name: "ğŸ”’ Restaurar permissÃµes de produÃ§Ã£o"
        run: |
          echo "ğŸ”’ Restaurando permissÃµes de produÃ§Ã£o..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deployer_key -p 3005 deployer@170.80.234.117 "
            # Restaurar dono para www-data
            sudo chown -R www-data:www-data /var/www/apis/lessions/
            
            # PermissÃµes padrÃ£o seguras para produÃ§Ã£o
            sudo find /var/www/apis/lessions -type f -exec chmod 644 {} \;
            sudo find /var/www/apis/lessions -type d -exec chmod 775 {} \;
            
            echo 'âœ… PermissÃµes de produÃ§Ã£o restauradas'
          "
          
      - name: "ğŸ“¦ Instalar/atualizar dependÃªncias"
        run: |
          echo "ğŸ“¦ Verificando dependÃªncias..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deployer_key -p 3005 deployer@170.80.234.117 "
            cd /var/www/apis/lessions
            source venv/bin/activate
            pip install -r requirements.txt
            echo 'âœ… DependÃªncias verificadas!'
          "
          
      - name: "ğŸ”„ Executar migraÃ§Ãµes do banco"
        run: |
          echo "ğŸ”„ Executando migraÃ§Ãµes..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deployer_key -p 3005 deployer@170.80.234.117 "
            cd /var/www/apis/lessions
            source venv/bin/activate
            alembic upgrade head
            echo 'âœ… MigraÃ§Ãµes aplicadas!'
          "
          
      - name: "âš¡ Reiniciar serviÃ§o"
        run: |
          echo "âš¡ Reiniciando serviÃ§o..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deployer_key -p 3005 deployer@170.80.234.117 "
            sudo systemctl restart lessions.service
            echo 'âœ… ServiÃ§o reiniciado!'
          "

      - name: "âœ… VerificaÃ§Ã£o final"
        run: |
          echo "âœ… Verificando deploy..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deployer_key -p 3005 deployer@170.80.234.117 "
            # Verificar se serviÃ§o estÃ¡ rodando
            if systemctl is-active lessions.service; then
              echo 'ğŸ‰ ServiÃ§o: ATIVO'
              
              # Verificar conteÃºdo do app.py
              echo 'ğŸ“„ ConteÃºdo do app.py (Ãºltimas linhas):'
              tail -5 /var/www/apis/lessions/app.py
              
              # Testar API
              echo 'ğŸŒ Testando API...'
              curl -s http://localhost:5000/ || echo 'API nÃ£o respondeu'
            else
              echo 'âŒ ServiÃ§o nÃ£o estÃ¡ rodando'
              systemctl status lessions.service
              exit 1
            fi
          "